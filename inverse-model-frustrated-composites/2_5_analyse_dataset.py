# -*- coding: utf-8 -*-
"""2.5- Analyse Dataset

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1pfC0Q0vWN-0SBnOxOsOpaA67FunHHlA7
"""
# Import Libraries
import h5py
import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import torch
import os

print("PyTorch version:", torch.__version__)
print("CUDA version:", torch.version.cuda)
print("CUDA available:", torch.cuda.is_available())
if torch.cuda.is_available():
    print(f"Using GPU: {torch.cuda.get_device_name(0)}")

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")


og_dataset_name = '24'
dataset_name = '24_All'
patches = '_Reshaped'


# Set dataset files
features_file_path = "C:/Gal_Msc/Ipublic-repo/frustrated-composites-dataset/" + og_dataset_name + '/' + dataset_name + '_Features' + patches + '.h5'
labels_file_path = "C:/Gal_Msc/Ipublic-repo/frustrated-composites-dataset/" + og_dataset_name + '/' + dataset_name + '_Labels' + patches + '.h5'


#labels_file_path = "C:/Gal_Msc/Ipublic-repo/frustrated-composites-dataset/" + og_dataset_name + '/' + dataset_name + '_Labels_Reshaped.h5'
#features_file_path = "C:/Gal_Msc/Ipublic-repo/frustrated-composites-dataset/" + og_dataset_name + '/' + dataset_name + '_Features_Reshaped.h5'

# Read Labels HDF5 File
with h5py.File(labels_file_path, 'r') as labels_file:
    labels_train = labels_file['Labels/Train']
    labels_test = labels_file['Labels/Test']

    # Ensure all elements are at least 1D arrays
    labels_train_data = [np.atleast_1d(labels_train[key][()]) for key in labels_train.keys()]
    labels_test_data = [np.atleast_1d(labels_test[key][()]) for key in labels_test.keys()]

    labels_train_flat = np.concatenate(labels_train_data)
    labels_test_flat = np.concatenate(labels_test_data)

    labels_all = np.concatenate((labels_train_flat, labels_test_flat))

# Read Features HDF5 File
with h5py.File(features_file_path, 'r') as features_file:
    features_train = features_file['Features/Train']
    features_test = features_file['Features/Test']

    features_train_data = [features_train[key][()] for key in features_train.keys()]
    features_test_data = [features_test[key][()] for key in features_test.keys()]

    features_train_flat = np.concatenate(features_train_data)
    features_test_flat = np.concatenate(features_test_data)

    features_all = np.concatenate((features_train_flat, features_test_flat))

# Create a directory to save plots
plot_dir = "plots"
if not os.path.exists(plot_dir):
    os.makedirs(plot_dir)

# 1. Distribution of Labels
unique, counts = np.unique(labels_all, return_counts=True)
plt.bar(unique, counts)
plt.xlabel('Label')
plt.ylabel('Frequency')
plt.title('Distribution of Labels')
plt.savefig(os.path.join(plot_dir, 'distribution_labels.png'))
plt.close()

# 1. Distribution of Labels for Train Data
unique_train, counts_train = np.unique(labels_train_flat, return_counts=True)
plt.bar(unique_train, counts_train)
plt.xlabel('Label')
plt.ylabel('Frequency')
plt.title('Distribution of Train Labels')
plt.savefig(os.path.join(plot_dir, 'distribution_train_labels.png'))
plt.show()
plt.close()

# 1. Distribution of Labels for Test Data
unique_test, counts_test = np.unique(labels_test_flat, return_counts=True)
plt.bar(unique_test, counts_test)
plt.xlabel('Label')
plt.ylabel('Frequency')
plt.title('Distribution of Test Labels')
plt.savefig(os.path.join(plot_dir, 'distribution_test_labels.png'))
plt.show()
plt.close()

# 2. Statistics for Each Feature Column
features_combined = np.vstack(features_all)
column_stats = {
    'max': np.max(features_combined, axis=0),
    'min': np.min(features_combined, axis=0),
    'median': np.median(features_combined, axis=0),
    'mean': np.mean(features_combined, axis=0)
}

print("Column statistics:")
for stat, values in column_stats.items():
    print(f"{stat.capitalize()}: {values}")

# 3. Statistics for Each Feature Column in a Structured Format
column_stats_df = pd.DataFrame(column_stats)
print(column_stats_df)

# 2. Statistics for Each Feature Column in Train Data
features_train_combined = np.vstack(features_train_flat)
column_stats_train = {
    'max': np.max(features_train_combined, axis=0),
    'min': np.min(features_train_combined, axis=0),
    'median': np.median(features_train_combined, axis=0),
    'mean': np.mean(features_train_combined, axis=0)
}

# Statistics for Each Feature Column in a Structured Format
print("Train Column statistics:")
column_stats_df = pd.DataFrame(column_stats_train)
print(column_stats_df)

# 3. Statistics for Each Feature Column in Test Data
features_test_combined = np.vstack(features_test_flat)
column_stats_test = {
    'max': np.max(features_test_combined, axis=0),
    'min': np.min(features_test_combined, axis=0),
    'median': np.median(features_test_combined, axis=0),
    'mean': np.mean(features_test_combined, axis=0)
}

# Statistics for Each Feature Column in a Structured Format
print("Test Column statistics:")
column_stats_df = pd.DataFrame(column_stats_test)
print(column_stats_df)

# 4. Distribution of Feature Values
num_columns = features_combined.shape[1]
for i in range(num_columns):
    plt.hist(features_combined[:, i], bins=50, alpha=0.75, label=f'Column {i+1}')
    plt.xlabel('Feature Value')
    plt.ylabel('Frequency')
    plt.title(f'Distribution of Feature Values - Column {i+1}')
    plt.legend()
    plt.savefig(os.path.join(plot_dir, f'distribution_feature_values_column_{i+1}.png'))
    plt.close()

# 4. Distribution of Feature Values for Train Data
num_columns_train = features_train_combined.shape[1]
for i in range(num_columns_train):
    plt.hist(features_train_combined[:, i], bins=50, alpha=0.75, label=f'Column {i+1}')
    plt.xlabel('Feature Value')
    plt.ylabel('Frequency')
    plt.title(f'Distribution of Train Feature Values - Column {i+1}')
    plt.legend()
    plt.savefig(os.path.join(plot_dir, f'distribution_train_feature_values_column_{i+1}.png'))
    plt.close()

# 4. Distribution of Feature Values for Test Data
num_columns_test = features_test_combined.shape[1]
for i in range(num_columns_test):
    plt.hist(features_test_combined[:, i], bins=50, alpha=0.75, label=f'Column {i+1}')
    plt.xlabel('Feature Value')
    plt.ylabel('Frequency')
    plt.title(f'Distribution of Test Feature Values - Column {i+1}')
    plt.legend()
    plt.savefig(os.path.join(plot_dir, f'distribution_test_feature_values_column_{i+1}.png'))
    plt.close()
